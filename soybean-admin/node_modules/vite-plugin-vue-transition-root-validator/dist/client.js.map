{"version":3,"file":"client.js","names":["title","lines","meta"],"sources":["../src/i18n.ts","../src/client.ts"],"sourcesContent":["import type { Lang } from './types.ts';\n\nexport type TransitionRootMessageContext = {\n  file?: string;\n  url?: string;\n  routeKey?: string;\n  component?: string;\n};\n\nconst translations = {\n  zh: {\n    messageHeader: '[vite-plugin-vue-transition-root-validator] 检测到 Vue Transition 多根节点错误',\n    setupInstructions: `\n如何在项目中启用此插件：\n\n1. 在 vite.config.ts 中添加插件：\n   import vitePluginVueTransitionRootValidator from 'vite-plugin-vue-transition-root-validator';\n\n   plugins: [\n     vitePluginVueTransitionRootValidator()\n   ]\n\n2. 在 src/main.ts 中初始化：\n   import { setupVueRootValidator } from 'virtual:vue-transition-root-validator';\n\n   const app = createApp(App);\n   setupVueRootValidator(app, { lang: 'zh' });\n   app.mount('#app');\n`\n  },\n  en: {\n    messageHeader: '[vite-plugin-vue-transition-root-validator] Vue Transition Multiple Root Nodes Error',\n    setupInstructions: `\nHow to enable this plugin in your project:\n\n1. Add plugin in vite.config.ts:\n   import vitePluginVueTransitionRootValidator from 'vite-plugin-vue-transition-root-validator';\n\n   plugins: [\n     vitePluginVueTransitionRootValidator()\n   ]\n\n2. Initialize in src/main.ts:\n   import { setupVueRootValidator } from 'virtual:vue-transition-root-validator';\n\n   const app = createApp(App);\n   setupVueRootValidator(app, { lang: 'en' });\n   app.mount('#app');\n`\n  }\n};\n\nexport function formatTransitionRootMessage(lang: Lang, ctx: TransitionRootMessageContext): string {\n  if (lang === 'zh') {\n    const title = 'Vue <Transition> 要求插槽内容具有单一的“元素根节点”。';\n    const lines: string[] = [];\n    lines.push(title);\n\n    if (ctx.file) lines.push(`\\n文件: ${ctx.file}`);\n    if (ctx.url) lines.push(`URL: ${ctx.url}`);\n\n    const meta: string[] = [];\n    if (ctx.component) meta.push(`component=${ctx.component}`);\n    if (ctx.routeKey) meta.push(`key=${ctx.routeKey}`);\n    if (meta.length) lines.push(`上下文: ${meta.join(' ')}`);\n\n    lines.push(\n      '\\n如何修复:\\n' +\n        `- 在${ctx.file ? `文件 ${ctx.file}` : '该组件'}的 <template> 最外层添加一个容器标签（如 <div> / <main>），把所有内容包起来，确保最终只渲染出一个根“标签元素”。\\n` +\n        '- 根节点不能是多个并列元素（Fragment/多根），也不能是纯文本或注释。\\n' +\n        '- 如果根部使用了 v-if / v-else，确保每个分支都只渲染一个根标签元素。'\n    );\n\n    lines.push(\n      '\\n为什么会这样:\\n' +\n        'Vue 的 <Transition> 需要把过渡 class 应用在一个真实的 DOM 元素上；' +\n        '当插槽内容渲染出的根节点不是“单一元素”（例如 Fragment、多根、纯文本或注释）时，就无法执行进入/离开过渡。'\n    );\n\n    lines.push('\\n相关文档:\\nhttps://cn.vuejs.org/guide/built-ins/transition#the-transition-component');\n\n    return lines.join('\\n');\n  }\n\n  // English\n  const title = 'Vue <Transition> requires a single element root node in its slot.';\n  const lines: string[] = [];\n  lines.push(title);\n\n  if (ctx.file) lines.push(`\\nFile: ${ctx.file}`);\n  if (ctx.url) lines.push(`URL: ${ctx.url}`);\n\n  const meta: string[] = [];\n  if (ctx.component) meta.push(`component=${ctx.component}`);\n  if (ctx.routeKey) meta.push(`key=${ctx.routeKey}`);\n  if (meta.length) lines.push(`Context: ${meta.join(' ')}`);\n\n  lines.push(\n    '\\nHow to fix:\\n' +\n      `- In the <template> of ${ctx.file ? `file ${ctx.file}` : 'this component'}, wrap everything with a single container element (e.g. <div> / <main>), so the final render has exactly one root *element*.\\n` +\n      '- The root cannot be a Fragment (multiple siblings), plain text, or a comment.\\n' +\n      '- If you use v-if / v-else at the root, ensure each branch renders exactly one root element.'\n  );\n\n  lines.push(\n    '\\nWhy this happens:\\n' +\n      'Vue <Transition> needs to apply transition classes to a real DOM element. ' +\n      'If the slot content renders a non-element root (Fragment/multiple roots/text/comment), Vue cannot animate it.'\n  );\n\n  lines.push('\\nDocs:\\nhttps://cn.vuejs.org/guide/built-ins/transition#the-transition-component');\n\n  return lines.join('\\n');\n}\n\nexport function getMessageHeader(lang: Lang): string {\n  return translations[lang].messageHeader;\n}\n\nexport function getSetupInstructions(lang: Lang): string {\n  return translations[lang].setupInstructions;\n}\n","import type { App, AppConfig, ComponentPublicInstance } from 'vue';\nimport type { Lang } from './types.ts';\nimport { formatTransitionRootMessage } from './i18n.ts';\n\n/**\n * Vue Transition 警告关键字\n * 用于识别 Vue 运行时发出的 Transition 多根节点警告\n */\nconst VUE_TRANSITION_WARN = 'Component inside <Transition> renders non-element root node that cannot be animated.';\n\n/**\n * 客户端配置选项\n */\ntype SetupOptions = {\n  /** 界面语言，默认 'en' */\n  lang?: Lang;\n  /** 是否在检测到错误后自动禁用检测（避免重复报错），默认 false */\n  disableAfterFirstError?: boolean;\n};\n\n/**\n * HMR 发送的消息载荷\n */\ntype Payload = {\n  key: string;\n  message: string;\n  lang: Lang;\n};\n\n/**\n * 从 Vue 警告信息中提取组件名称\n * 示例: \"at <Index onVnodeUnmounted=... key=\"/test\" ... >\"\n */\nfunction extractComponentName(text: string): string | undefined {\n  const m = text.match(/at <([^\\s>]+)/);\n  return m?.[1];\n}\n\n/**\n * 从 Vue 警告信息中提取路由 key\n * 示例: key=\"/test\"\n */\nfunction extractRouteKey(text: string): string | undefined {\n  // eslint-disable-next-line no-useless-escape\n  const m = text.match(/key=\\\"([^\\\"]+)\\\"/);\n  return m?.[1];\n}\n\n/**\n * 获取组件实例可能对应的文件路径\n */\nfunction guessViewFileFromInstance(instance: ComponentPublicInstance | null | undefined): string | undefined {\n  if (!instance) return undefined;\n\n  // eslint-disable-next-line dot-notation\n  return (instance.$options as any)['__file'];\n}\n\n/**\n * 获取组件实例可能对应的文件路径\n */\nfunction getViewUrlFromInstance(instance: ComponentPublicInstance | null | undefined): string | undefined {\n  if (!instance) return undefined;\n\n  return instance.$el?.baseURI;\n}\n\n/**\n * 检查插件是否已经安装\n */\nfunction alreadyInstalled(): boolean {\n  // eslint-disable-next-line dot-notation\n  return Boolean((globalThis as any)['__VITE_PLUGIN_VUE_TRANSITION_ROOT_VALIDATOR_INSTALLED__']);\n}\n\n/**\n * 标记插件已安装\n */\nfunction markInstalled() {\n  // eslint-disable-next-line dot-notation\n  (globalThis as any)['__VITE_PLUGIN_VUE_TRANSITION_ROOT_VALIDATOR_INSTALLED__'] = true;\n}\n\n/**\n * 通过 HMR WebSocket 向 Vite 服务器发送消息\n */\ntype HotLike = {\n  send?: (event: string, payload: unknown) => void;\n  on?: (event: string, cb: (data: any) => void) => void;\n};\n\nconst pendingPayloads = new Map<string, Payload>();\nlet listenersBound = false;\nlet retryTimer: number | null = null;\nlet retryDelayMs = 200;\n\nfunction getHot(): HotLike | undefined {\n  return (import.meta as any).hot as HotLike | undefined;\n}\n\nfunction trySendNow(payload: Payload): boolean {\n  const hot = getHot();\n  if (!hot?.send) return false;\n\n  try {\n    hot.send('vite-plugin-vue-transition-root-validator:vue-warn', payload);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nfunction scheduleRetry() {\n  if (retryTimer !== null) return;\n\n  // 轻量兜底：如果错过了 vite:ws:connect 事件，也会在短时间内尝试重发。\n  retryTimer = globalThis.setTimeout(() => {\n    retryTimer = null;\n    flushPendingPayloads();\n\n    // 如果还有积压，继续重试（指数退避，避免持续高频）\n    if (pendingPayloads.size) {\n      retryDelayMs = Math.min(retryDelayMs * 2, 2000);\n      scheduleRetry();\n    }\n  }, retryDelayMs) as unknown as number;\n}\n\nfunction flushPendingPayloads() {\n  if (!pendingPayloads.size) return;\n\n  // fire-and-forget：是否送达由服务端 ACK 决定；未 ACK 的会继续重试\n  for (const p of pendingPayloads.values()) {\n    trySendNow(p);\n  }\n}\n\nfunction bindHmrListenersOnce() {\n  if (listenersBound) return;\n  listenersBound = true;\n\n  const hot = getHot();\n  if (!hot?.on) return;\n\n  // 连接建立后立刻 flush 一次，减少首屏丢消息的概率\n  hot.on('vite:ws:connect', () => {\n    retryDelayMs = 200;\n    if (retryTimer !== null) {\n      clearTimeout(retryTimer);\n      retryTimer = null;\n    }\n    flushPendingPayloads();\n  });\n\n  // 服务端 ACK：用于清理重试队列，避免重复发送\n  hot.on('vite-plugin-vue-transition-root-validator:ack', (data: any) => {\n    const key = data?.key;\n    if (!key) return;\n\n    pendingPayloads.delete(key);\n    if (!pendingPayloads.size) {\n      retryDelayMs = 200;\n      if (retryTimer !== null) {\n        clearTimeout(retryTimer);\n        retryTimer = null;\n      }\n    }\n  });\n}\n\nfunction send(payload: Payload) {\n  // 仅在开发环境且 HMR 启用时工作\n  const hot = getHot();\n  if (!hot?.send) return;\n\n  bindHmrListenersOnce();\n\n  pendingPayloads.set(payload.key, payload);\n  trySendNow(payload);\n  scheduleRetry();\n}\n\nlet originalWarnHandler: null | AppConfig['warnHandler'] = null;\n\nfunction resendLog(msg: string, instance: ComponentPublicInstance | null, trace: string) {\n  if (originalWarnHandler) {\n    originalWarnHandler(msg, instance, trace);\n  }\n}\n\n/**\n * 设置 Vue Root Validator\n *\n * 在 Vue 应用上注册 warnHandler 来捕获 Transition 多根节点警告\n *\n * @param app - Vue 应用实例\n * @param options - 配置选项\n *\n * @example\n * ```ts\n * import { createApp } from 'vue';\n * import { setupVueRootValidator } from 'virtual:vue-transition-root-validator';\n * import App from './App.vue';\n *\n * const app = createApp(App);\n *\n * // 在挂载前设置验证器\n * setupVueRootValidator(app, { lang: 'zh' });\n *\n * app.mount('#app');\n * ```\n */\nexport function setupVueRootValidator(app: App, options: SetupOptions = {}) {\n  // 防止重复安装\n  if (alreadyInstalled()) {\n    return;\n  }\n  markInstalled();\n\n  const lang: Lang = options.lang ?? 'en';\n  const disableAfterFirstError = options.disableAfterFirstError ?? false;\n\n  // 尽早绑定 HMR 连接监听，避免首次触发 warning 时 ws 尚未 ready。\n  bindHmrListenersOnce();\n\n  // 保存原始的 warnHandler（如果有）\n  originalWarnHandler = app.config.warnHandler;\n\n  // 用于防抖，避免同一错误重复发送\n  let lastSentAt = 0;\n  let lastSentKey = '';\n  let errorSent = false;\n\n  /**\n   * 自定义 Vue 警告处理器\n   *\n   * @param msg - 警告消息\n   * @param instance - 组件实例\n   * @param trace - 组件追踪栈\n   */\n  app.config.warnHandler = (msg: string, instance: ComponentPublicInstance | null, trace: string) => {\n    resendLog(msg, instance, trace);\n    // 如果已经发送过错误且配置为只发送一次，则跳过\n    if (disableAfterFirstError && errorSent) {\n      return;\n    }\n\n    // 检查是否是 Transition 多根节点警告\n    const matched = msg.includes(VUE_TRANSITION_WARN);\n\n    if (!matched) {\n      // 不是目标警告\n      return;\n    }\n\n    // 防抖处理：避免短时间内重复发送同一个错误\n    const now = Date.now();\n    const text = msg + trace;\n    const key = text.slice(0, 400);\n\n    if (now - lastSentAt > 500 || key !== lastSentKey) {\n      lastSentAt = now;\n      lastSentKey = key;\n\n      // 从 trace 中提取信息\n      const routeKey = extractRouteKey(trace);\n      const component = extractComponentName(trace);\n      const file = guessViewFileFromInstance(instance);\n      const url = getViewUrlFromInstance(instance);\n\n      // 格式化错误消息\n      const message = formatTransitionRootMessage(lang, {\n        url,\n        file,\n        routeKey,\n        component\n      });\n\n      // 发送到 Vite 服务器\n      send({ key: message.slice(0, 800), message, lang });\n\n      errorSent = true;\n    }\n  };\n}\n"],"mappings":"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"}