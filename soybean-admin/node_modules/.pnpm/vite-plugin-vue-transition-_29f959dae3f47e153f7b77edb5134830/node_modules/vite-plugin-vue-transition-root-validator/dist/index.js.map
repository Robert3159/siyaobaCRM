{"version":3,"file":"index.js","names":[],"sources":["../src/i18n.ts","../src/index.ts"],"sourcesContent":["import type { Lang } from './types.ts';\n\nexport type TransitionRootMessageContext = {\n  file?: string;\n  url?: string;\n  routeKey?: string;\n  component?: string;\n};\n\nconst translations = {\n  zh: {\n    messageHeader: '[vite-plugin-vue-transition-root-validator] 检测到 Vue Transition 多根节点错误',\n    setupInstructions: `\n如何在项目中启用此插件：\n\n1. 在 vite.config.ts 中添加插件：\n   import vitePluginVueTransitionRootValidator from 'vite-plugin-vue-transition-root-validator';\n\n   plugins: [\n     vitePluginVueTransitionRootValidator()\n   ]\n\n2. 在 src/main.ts 中初始化：\n   import { setupVueRootValidator } from 'virtual:vue-transition-root-validator';\n\n   const app = createApp(App);\n   setupVueRootValidator(app, { lang: 'zh' });\n   app.mount('#app');\n`\n  },\n  en: {\n    messageHeader: '[vite-plugin-vue-transition-root-validator] Vue Transition Multiple Root Nodes Error',\n    setupInstructions: `\nHow to enable this plugin in your project:\n\n1. Add plugin in vite.config.ts:\n   import vitePluginVueTransitionRootValidator from 'vite-plugin-vue-transition-root-validator';\n\n   plugins: [\n     vitePluginVueTransitionRootValidator()\n   ]\n\n2. Initialize in src/main.ts:\n   import { setupVueRootValidator } from 'virtual:vue-transition-root-validator';\n\n   const app = createApp(App);\n   setupVueRootValidator(app, { lang: 'en' });\n   app.mount('#app');\n`\n  }\n};\n\nexport function formatTransitionRootMessage(lang: Lang, ctx: TransitionRootMessageContext): string {\n  if (lang === 'zh') {\n    const title = 'Vue <Transition> 要求插槽内容具有单一的“元素根节点”。';\n    const lines: string[] = [];\n    lines.push(title);\n\n    if (ctx.file) lines.push(`\\n文件: ${ctx.file}`);\n    if (ctx.url) lines.push(`URL: ${ctx.url}`);\n\n    const meta: string[] = [];\n    if (ctx.component) meta.push(`component=${ctx.component}`);\n    if (ctx.routeKey) meta.push(`key=${ctx.routeKey}`);\n    if (meta.length) lines.push(`上下文: ${meta.join(' ')}`);\n\n    lines.push(\n      '\\n如何修复:\\n' +\n        `- 在${ctx.file ? `文件 ${ctx.file}` : '该组件'}的 <template> 最外层添加一个容器标签（如 <div> / <main>），把所有内容包起来，确保最终只渲染出一个根“标签元素”。\\n` +\n        '- 根节点不能是多个并列元素（Fragment/多根），也不能是纯文本或注释。\\n' +\n        '- 如果根部使用了 v-if / v-else，确保每个分支都只渲染一个根标签元素。'\n    );\n\n    lines.push(\n      '\\n为什么会这样:\\n' +\n        'Vue 的 <Transition> 需要把过渡 class 应用在一个真实的 DOM 元素上；' +\n        '当插槽内容渲染出的根节点不是“单一元素”（例如 Fragment、多根、纯文本或注释）时，就无法执行进入/离开过渡。'\n    );\n\n    lines.push('\\n相关文档:\\nhttps://cn.vuejs.org/guide/built-ins/transition#the-transition-component');\n\n    return lines.join('\\n');\n  }\n\n  // English\n  const title = 'Vue <Transition> requires a single element root node in its slot.';\n  const lines: string[] = [];\n  lines.push(title);\n\n  if (ctx.file) lines.push(`\\nFile: ${ctx.file}`);\n  if (ctx.url) lines.push(`URL: ${ctx.url}`);\n\n  const meta: string[] = [];\n  if (ctx.component) meta.push(`component=${ctx.component}`);\n  if (ctx.routeKey) meta.push(`key=${ctx.routeKey}`);\n  if (meta.length) lines.push(`Context: ${meta.join(' ')}`);\n\n  lines.push(\n    '\\nHow to fix:\\n' +\n      `- In the <template> of ${ctx.file ? `file ${ctx.file}` : 'this component'}, wrap everything with a single container element (e.g. <div> / <main>), so the final render has exactly one root *element*.\\n` +\n      '- The root cannot be a Fragment (multiple siblings), plain text, or a comment.\\n' +\n      '- If you use v-if / v-else at the root, ensure each branch renders exactly one root element.'\n  );\n\n  lines.push(\n    '\\nWhy this happens:\\n' +\n      'Vue <Transition> needs to apply transition classes to a real DOM element. ' +\n      'If the slot content renders a non-element root (Fragment/multiple roots/text/comment), Vue cannot animate it.'\n  );\n\n  lines.push('\\nDocs:\\nhttps://cn.vuejs.org/guide/built-ins/transition#the-transition-component');\n\n  return lines.join('\\n');\n}\n\nexport function getMessageHeader(lang: Lang): string {\n  return translations[lang].messageHeader;\n}\n\nexport function getSetupInstructions(lang: Lang): string {\n  return translations[lang].setupInstructions;\n}\n","import { fileURLToPath } from 'node:url';\nimport { existsSync } from 'node:fs';\nimport type { Lang } from './types.ts';\nimport { getMessageHeader } from './i18n.ts';\n\n/**\n * Vite DevServer 类型（精简版）\n */\ntype DevServerLike = {\n  ws: {\n    send: (payload: { type: 'error'; err: { message: string; stack?: string } }) => void;\n    on: (event: string, listener: (payload: any, client: any) => void) => void;\n  };\n  config: {\n    logger: {\n      warn: (msg: string) => void;\n      info: (msg: string) => void;\n    };\n  };\n};\n\ntype DevClientLike = {\n  send?: {\n    (payload: { type: 'error'; err: { message: string; stack?: string } }): void;\n    (event: string, payload?: any): void;\n  };\n};\n\n/**\n * Vite ResolvedConfig 类型（精简版）\n */\ntype ResolvedConfigLike = {\n  command: 'serve' | 'build' | string;\n};\n\n/**\n * 发送错误覆盖层到客户端（优先定向发送，避免首屏时广播命中不到当前 client）\n */\nfunction sendErrorOverlay(args: { server: DevServerLike; message: string; lang: Lang; client?: DevClientLike }) {\n  const { server, message, lang, client } = args;\n  const payload = {\n    type: 'error',\n    err: {\n      message: getMessageHeader(lang),\n      stack: message\n    }\n  } as const;\n\n  if (client?.send) {\n    client.send(payload);\n    return;\n  }\n\n  server.ws.send(payload);\n}\n\n/**\n * 客户端上报的消息载荷\n */\ntype ClientReportPayload = {\n  message: string;\n  /** 用于 ACK 去重/确认（客户端可不传，服务端会回退使用 message 截断值） */\n  key?: string;\n  /** 客户端运行时语言（推荐从 main.ts 传入并上报），用于决定 overlay header 语言 */\n  lang?: Lang;\n};\n\n/**\n * Vite 插件：Vue Root Validator\n *\n * 用于检测 Vue 组件在 <Transition> 内渲染时的多根节点问题\n *\n * @returns Vite 插件对象\n *\n * @example\n * ```ts\n * // vite.config.ts\n * import vitePluginVueTransitionRootValidator from 'vite-plugin-vue-transition-root-validator';\n *\n * export default defineConfig({\n *   plugins: [\n *     vitePluginVueTransitionRootValidator()\n *   ]\n * });\n * ```\n */\nexport default function vitePluginVueTransitionRootValidator() {\n  let resolved: ResolvedConfigLike;\n\n  return {\n    name: 'vite-plugin-vue-transition-root-validator',\n    apply: 'serve' as const, // 仅在开发环境应用\n\n    /**\n     * 保存解析后的配置\n     */\n    configResolved(config: ResolvedConfigLike) {\n      resolved = config;\n    },\n\n    /**\n     * 配置开发服务器\n     * 监听客户端上报的警告消息，并通过 error overlay 显示\n     */\n    configureServer(server: DevServerLike) {\n      if (resolved.command !== 'serve') return;\n\n      // 用于去重，避免同一客户端重复发送相同消息\n      const lastByClient = new WeakMap<object, string>();\n\n      // 监听客户端上报的警告\n      server.ws.on('vite-plugin-vue-transition-root-validator:vue-warn', (payload: ClientReportPayload, client: object) => {\n        if (!payload?.message) return;\n\n        // 去重处理\n        const key = payload.key ?? payload.message.slice(0, 800);\n        const prev = lastByClient.get(client as unknown as object);\n        if (prev === key) {\n          // 仍然回 ACK，避免客户端重试积压\n          (client as any as DevClientLike)?.send?.('vite-plugin-vue-transition-root-validator:ack', { key });\n          return;\n        }\n        lastByClient.set(client as unknown as object, key);\n\n        const effectiveLang: Lang = payload.lang ?? 'en';\n\n        // 发送错误覆盖层\n        sendErrorOverlay({\n          server,\n          message: payload.message,\n          lang: effectiveLang,\n          client: client as any as DevClientLike\n        });\n\n        // 回 ACK，通知客户端该消息已被处理（用于清理重试队列）\n        (client as any as DevClientLike)?.send?.('vite-plugin-vue-transition-root-validator:ack', { key });\n      });\n    },\n\n    /**\n     * 解析虚拟模块\n     * 处理 'virtual:vue-transition-root-validator' 模块的导入\n     */\n    resolveId(id: string) {\n      if (id === 'virtual:vue-transition-root-validator') {\n        // 返回一个虚拟模块 ID，加上 \\0 前缀表示这是一个虚拟模块\n        return '\\0virtual:vue-transition-root-validator';\n      }\n      return null;\n    },\n\n    /**\n     * 加载虚拟模块\n     * 返回虚拟模块的代码内容\n     */\n    load(id: string) {\n      if (id === '\\0virtual:vue-transition-root-validator') {\n        const clientEntryTs = fileURLToPath(new URL('./client.ts', import.meta.url));\n        const clientEntryJs = fileURLToPath(new URL('./client.js', import.meta.url));\n        const clientEntry = existsSync(clientEntryTs) ? clientEntryTs : clientEntryJs;\n        const clientUrl = `/@fs/${clientEntry.replace(/\\\\/g, '/')}`;\n\n        // 返回虚拟模块代码：重新导出 client.ts 的函数\n        return `\n// 虚拟模块：vue-transition-root-validator\n// 此模块由 vite-plugin-vue-transition-root-validator 插件自动生成\n\nimport { setupVueRootValidator } from ${JSON.stringify(clientUrl)};\n\n// 重新导出函数\nexport { setupVueRootValidator };\n`;\n      }\n      return null;\n    }\n  };\n}\n\n\n"],"mappings":";;;;AASA,MAAM,eAAe;CACnB,IAAI;EACF,eAAe;EACf,mBAAmB;;;;;;;;;;;;;;;;;EAiBpB;CACD,IAAI;EACF,eAAe;EACf,mBAAmB;;;;;;;;;;;;;;;;;EAiBpB;CACF;AAiED,SAAgB,iBAAiB,MAAoB;AACnD,QAAO,aAAa,MAAM;;;;;;;;AC9E5B,SAAS,iBAAiB,MAAsF;CAC9G,MAAM,EAAE,QAAQ,SAAS,MAAM,WAAW;CAC1C,MAAM,UAAU;EACd,MAAM;EACN,KAAK;GACH,SAAS,iBAAiB,KAAK;GAC/B,OAAO;GACR;EACF;AAED,KAAI,QAAQ,MAAM;AAChB,SAAO,KAAK,QAAQ;AACpB;;AAGF,QAAO,GAAG,KAAK,QAAQ;;;;;;;;;;;;;;;;;;;;;AAiCzB,SAAwB,uCAAuC;CAC7D,IAAI;AAEJ,QAAO;EACL,MAAM;EACN,OAAO;EAKP,eAAe,QAA4B;AACzC,cAAW;;EAOb,gBAAgB,QAAuB;AACrC,OAAI,SAAS,YAAY,QAAS;GAGlC,MAAM,+BAAe,IAAI,SAAyB;AAGlD,UAAO,GAAG,GAAG,uDAAuD,SAA8B,WAAmB;AACnH,QAAI,CAAC,SAAS,QAAS;IAGvB,MAAM,MAAM,QAAQ,OAAO,QAAQ,QAAQ,MAAM,GAAG,IAAI;AAExD,QADa,aAAa,IAAI,OAA4B,KAC7C,KAAK;AAEhB,KAAC,QAAiC,OAAO,iDAAiD,EAAE,KAAK,CAAC;AAClG;;AAEF,iBAAa,IAAI,QAA6B,IAAI;IAElD,MAAM,gBAAsB,QAAQ,QAAQ;AAG5C,qBAAiB;KACf;KACA,SAAS,QAAQ;KACjB,MAAM;KACE;KACT,CAAC;AAGF,IAAC,QAAiC,OAAO,iDAAiD,EAAE,KAAK,CAAC;KAClG;;EAOJ,UAAU,IAAY;AACpB,OAAI,OAAO,wCAET,QAAO;AAET,UAAO;;EAOT,KAAK,IAAY;AACf,OAAI,OAAO,2CAA2C;IACpD,MAAM,gBAAgB,cAAc,IAAI,IAAI,eAAe,OAAO,KAAK,IAAI,CAAC;IAC5E,MAAM,gBAAgB,cAAc,IAAI,IAAI,eAAe,OAAO,KAAK,IAAI,CAAC;IAE5E,MAAM,YAAY,SADE,WAAW,cAAc,GAAG,gBAAgB,eAC1B,QAAQ,OAAO,IAAI;AAGzD,WAAO;;;;wCAIyB,KAAK,UAAU,UAAU,CAAC;;;;;;AAM5D,UAAO;;EAEV"}